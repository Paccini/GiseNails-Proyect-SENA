{% extends 'home.html' %} 

{% block title %}Reserva{% endblock %} 

{% block content %} 
{% load static %} 


<link rel="stylesheet" href="{% static 'css/reserva.css' %}">

<div class="reserva-container">
    <div class="header">
        <h1>Gise-Nails</h1>
        <div class="info"><i class="bi bi-geo-alt-fill"></i> Cra 9a #42-44 B/calarca</div>
        <div class="info"><i class="bi bi-envelope-at"></i> giselav489@gmail.com</div>
        <div class="info"><i class="bi bi-telephone"></i> 300 204 0538</div>
    </div>
    
    <div class="main-content">
        <section class="form-section">
            <h2>Reserva tu cita</h2>
            <form method="post" action="">
                {% csrf_token %}
                <input type="text" name="nombre" placeholder="Nombre" required>
                <input type="text" name="telefono" placeholder="Teléfono" required>
                <input type="email" name="correo" placeholder="Correo electrónico" required>

             <select name="gestora" id="gestora-select" required>
                    <option value="">Selecciona gestora</option>
                    {% for gestora in gestoras %}
                        <option value="{{ gestora.id }}">{{ gestora.nombre }} {{ gestora.apellidos }}</option>
                    {% endfor %}
             </select>
             
                <!-- Select para tipo de servicio -->
                <select id="tipo-servicio" required>
                    <option value="">Selecciona tipo de servicio</option>
                    <option value="manicure">Manicure</option>
                    <option value="pedicure">Pedicure</option>
                    <option value="estructura">Estructura de uñas</option>
                </select>

                <!-- campo oculto que contendrá el id del servicio seleccionado -->
                <input type="hidden" name="servicio" id="servicio-input">

             
        

                <input type="text" name="fecha" id="fecha-select" required placeholder="Selecciona la fecha">

                <select name="hora" id="horario-select" required>
                    <option value="">Selecciona horario</option>
                </select>

                <!-- Contenedor para mostrar los servicios con imágenes -->
                <div id="servicios-contenedor" class="servicios-list"></div>

                <button type="submit">Confirmar cita</button>
            </form>
        </section>
    </div>
</div>

<!-- Servicios agrupados por categoría en formato JSON seguro -->
<script id="servicios-data" type="application/json">
    {
        "manicure": [
            {% for s in servicios_por_categoria.manicure %}
                {
                    "id": "{{ s.id }}",
                    "nombre": "{{ s.nombre|escapejs }}",
                    "precio": "{{ s.precio }}",
                    "imagen": "{{ s.imagen.url }}"
                }{% if not forloop.last %},{% endif %}
            {% endfor %}
        ],
        "pedicure": [
            {% for s in servicios_por_categoria.pedicure %}
                {
                    "id": "{{ s.id }}",
                    "nombre": "{{ s.nombre|escapejs }}",
                    "precio": "{{ s.precio }}",
                    "imagen": "{{ s.imagen.url }}"
                }{% if not forloop.last %},{% endif %}
            {% endfor %}
        ],
        "estructura": [
            {% for s in servicios_por_categoria.estructura %}
                {
                    "id": "{{ s.id }}",
                    "nombre": "{{ s.nombre|escapejs }}",
                    "precio": "{{ s.precio }}",
                    "imagen": "{{ s.imagen.url }}"
                }{% if not forloop.last %},{% endif %}
            {% endfor %}
        ]
    }
</script>

<!-- Flatpickr CSS y JS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="{% static 'js/servicios.js' %}"></script>
<script src="{% static 'js/reserva2.js' %}"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        flatpickr("#fecha-select", {
            dateFormat: "d/m/Y",
            minDate: "today",
            locale: "es"
        });
    });
</script>

<!-- Mensaje de confirmación de cita (añadir dentro de block content) -->
<div id="reserva-success-modal" class="reserva-success-modal" aria-hidden="true">
  <div class="reserva-success-card">
    <button id="reserva-success-close" class="reserva-success-close" aria-label="Cerrar">&times;</button>
    <img src="{% static 'img/Logo gisel-nails.png' %}" alt="Logo" class="reserva-success-logo" />
    <h2>¡Cita reservada!</h2>
    <p class="reserva-success-text">Tu cita se ha guardado correctamente. Te hemos enviado un correo de confirmación (revisa tu bandeja y spam).</p>
    <div class="reserva-success-actions">
      <a href="{% url 'inicio' %}" class="btn btn-secondary">Volver al inicio</a>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function(){
  const params = new URLSearchParams(window.location.search);
  if(params.get('success') === '1'){
    const modal = document.getElementById('reserva-success-modal');
    modal.setAttribute('aria-hidden','false');
    // quitar el parámetro ?success=1 de la URL (sin recargar)
    const url = new URL(window.location);
    url.searchParams.delete('success');
    window.history.replaceState({}, document.title, url.toString());
    // botón cerrar
    document.getElementById('reserva-success-close').addEventListener('click', function(){
      modal.setAttribute('aria-hidden','true');
    });
    // cerrar click fuera de la tarjeta
    modal.addEventListener('click', function(e){
      if(e.target === modal){
        modal.setAttribute('aria-hidden','true');
      }
    });
  }
});
</script>

{% endblock %}