{% extends 'home.html' %} 

{% block title %}Reserva{% endblock %} 

{% block content %} 
{% load static %} 

<!-- Enlace al archivo CSS principal de la sección de reservas -->
<link rel="stylesheet" href="{% static 'css/reserva.css' %}">

<!-- Contenedor general de la página de reserva -->
<div class="reserva-container">

    <!-- Encabezado con logo e información de contacto -->
    <header class="reserva-header">
        <div class="marca">
            <img src="{% static 'img/Logo gisel-nails.png' %}" alt="Gise-Nails" class="logo">
            <div class="marca-texto">
                <h1>Gise-Nails</h1>
                <p class="direccion">
                    Cra 9a #42-44, B/Calarca · 
                    <span class="email">giselav489@gmail.com</span> · 
                    <span class="telefono">300 204 0538</span>
                </p>
            </div>
        </div>
    </header>

    <!-- Contenido principal -->
    <main class="main-content">
        <section class="form-section">

            <!-- Título e instrucciones del formulario -->
            <h2>Reserva tu cita</h2>
            <p class="instrucciones">
                Rellena tus datos, elige categoría y haz clic en el servicio para ver el resumen antes de confirmar.
            </p>

            <!-- Formulario de reserva -->
            <form method="post" action="" class="reserva-form" novalidate>
                {% csrf_token %}

                <!-- Campos de información del cliente -->
                <label for="nombre">Nombre</label>
                <input id="nombre" type="text" name="nombre" placeholder="Ej. Ana Pérez" required>

                <label for="telefono">Teléfono</label>
                <input id="telefono" type="tel" name="telefono" placeholder="300 000 0000" required>

                <label for="correo">Correo (opcional)</label>
                <input id="correo" type="email" name="correo" placeholder="tu@correo.com">

                <!-- Selector de gestora asignada -->
                <label for="gestora-select">Gestora</label>
                <select name="gestora" id="gestora-select" required>
                    <option value="">Selecciona gestora</option>
                    {% for gestora in gestoras %}
                        <option value="{{ gestora.id }}">{{ gestora.nombre }} {{ gestora.apellidos }}</option>
                    {% endfor %}
                </select>

                <!-- Selector de categoría -->
                <label for="tipo-servicio">Categoría de servicio</label>
                <select name="tipo_servicio" id="tipo-servicio" required>
                    <option value="">Selecciona categoría</option>
                    <option value="manicure">Manicure</option>
                    <option value="pedicure">Pedicure</option>
                    <option value="estructura">Estructura de uñas</option>
                </select>

                <!-- Campo oculto para guardar el ID del servicio elegido -->
                <input type="hidden" name="servicio" id="servicio-input">

                <!-- Selección de fecha -->
                <label for="fecha-select">Fecha</label>
                <input id="fecha-select" type="text" name="fecha" required placeholder="DD/MM/AAAA">

                <!-- Selección de horario -->
                <label for="horario-select">Horario</label>
                <select name="hora" id="horario-select" required>
                    <option value="">Selecciona horario</option>
                </select>

                <!-- Resumen dinámico del servicio seleccionado -->
                <div id="resumen-servicio" class="selected-summary" aria-live="polite" hidden>
                    <img id="resumen-img" src="" alt="" />
                    <div class="meta">
                        <strong id="resumen-nombre">Sin servicio</strong>
                        <div class="precio" id="resumen-precio"></div>
                        <div class="categoria" id="resumen-categoria"></div>
                    </div>
                </div>

                <!-- Contenedor donde se renderizan los servicios disponibles -->
                <h3 class="servicios-titulo">Servicios disponibles</h3>
                <div id="servicios-contenedor" class="servicios-list" role="list"></div>

                <!-- Botones de acción -->
                <div class="acciones">
                    <button type="submit" class="btn-confirm">Confirmar cita</button>
                    <a href="{% url 'inicio' %}" class="btn-cancel">Volver</a>
                </div>
            </form>
        </section>
    </main>
</div>
<!-- Fin del contenedor principal -->

<!-- Datos JSON con los servicios agrupados por categoría -->
<script id="servicios-data" type="application/json">
    {
        "manicure": [
            {% for s in servicios_por_categoria.manicure %}
                {
                    "id": "{{ s.id }}",
                    "nombre": "{{ s.nombre|escapejs }}",
                    "precio": "{{ s.precio }}",
                    "imagen": "{{ s.imagen.url }}"
                }{% if not forloop.last %},{% endif %}
            {% endfor %}
        ],
        "pedicure": [
            {% for s in servicios_por_categoria.pedicure %}
                {
                    "id": "{{ s.id }}",
                    "nombre": "{{ s.nombre|escapejs }}",
                    "precio": "{{ s.precio }}",
                    "imagen": "{{ s.imagen.url }}"
                }{% if not forloop.last %},{% endif %}
            {% endfor %}
        ],
        "estructura": [
            {% for s in servicios_por_categoria.estructura %}
                {
                    "id": "{{ s.id }}",
                    "nombre": "{{ s.nombre|escapejs }}",
                    "precio": "{{ s.precio }}",
                    "imagen": "{{ s.imagen.url }}"
                }{% if not forloop.last %},{% endif %}
            {% endfor %}
        ]
    }
</script>

<!-- Librería Flatpickr para el selector de fechas -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<!-- Archivos JavaScript personalizados -->
<script src="{% static 'js/servicios.js' %}"></script>
<script src="{% static 'js/reserva2.js' %}"></script>

<!-- Inicialización de Flatpickr -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        flatpickr("#fecha-select", {
            dateFormat: "d/m/Y",
            minDate: "today",
            locale: "es"
        });
    });
</script>

<!-- Modal de confirmación de cita -->
<div id="reserva-success-modal" class="reserva-success-modal" aria-hidden="true">
  <div class="reserva-success-card">
    <button id="reserva-success-close" class="reserva-success-close" aria-label="Cerrar">&times;</button>
    <img src="{% static 'img/Logo gisel-nails.png' %}" alt="Logo" class="reserva-success-logo" />
    <h2>¡Cita reservada!</h2>
    <p class="reserva-success-text">
      Tu cita se ha guardado correctamente. Te hemos enviado un correo de confirmación 
      (revisa tu bandeja y spam).
    </p>
    <div class="reserva-success-actions">
      <a href="{% url 'inicio' %}" class="btn btn-secondary">Volver al inicio</a>
    </div>
  </div>
</div>

<!-- Script para controlar la visualización del modal de éxito -->
<script>
document.addEventListener('DOMContentLoaded', function(){
  const params = new URLSearchParams(window.location.search);
  if(params.get('success') === '1'){
    const modal = document.getElementById('reserva-success-modal');
    modal.setAttribute('aria-hidden','false');
    
    /* Quita el parámetro ?success=1 de la URL sin recargar la página */
    const url = new URL(window.location);
    url.searchParams.delete('success');
    window.history.replaceState({}, document.title, url.toString());
    
    /* Cierra el modal al hacer clic en la X */
    document.getElementById('reserva-success-close').addEventListener('click', function(){
      modal.setAttribute('aria-hidden','true');
    });
    
    /* Cierra el modal si se hace clic fuera de la tarjeta */
    modal.addEventListener('click', function(e){
      if(e.target === modal){
        modal.setAttribute('aria-hidden','true');
      }
    });
  }
});
</script>

<!-- Script para renderizar dinámicamente los servicios y mostrar el resumen -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  const serviciosData = JSON.parse(document.getElementById('servicios-data').textContent || '{}');
  const contenedor = document.getElementById('servicios-contenedor');
  const tipoSelect = document.getElementById('tipo-servicio');
  const servicioInput = document.getElementById('servicio-input');

  const resumen = document.getElementById('resumen-servicio');
  const resumenImg = document.getElementById('resumen-img');
  const resumenNombre = document.getElementById('resumen-nombre');
  const resumenPrecio = document.getElementById('resumen-precio');
  const resumenCategoria = document.getElementById('resumen-categoria');

  let currentCategory = '';

  /* Crea la estructura de una tarjeta de servicio */
  function createCardElement(s) {
    const card = document.createElement('div');
    card.className = 'servicio-card';
    card.innerHTML = `
      <img src="${s.imagen}" alt="${s.nombre}" class="servicio-img"/>
      <div class="servicio-body">
        <div class="servicio-nombre">${s.nombre}</div>
        <div class="servicio-precio">$${s.precio}</div>
      </div>
    `;
    return card;
  }

  /* Renderiza los servicios de la categoría seleccionada */
  function renderServicios(categoria) {
    currentCategory = categoria || '';
    contenedor.innerHTML = '';
    const lista = serviciosData[categoria] || [];

    if (!lista.length) {
      contenedor.innerHTML = '<p class="no-servicios">No hay servicios en esta categoría.</p>';
      return;
    }

    lista.forEach(s => {
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'servicio-card';
      btn.setAttribute('aria-label', `${s.nombre} $${s.precio}`);
      btn.innerHTML = `
        <img src="${s.imagen}" alt="${s.nombre}" class="servicio-img"/>
        <div class="servicio-body">
          <div class="servicio-nombre">${s.nombre}</div>
          <div class="servicio-precio">$${s.precio}</div>
        </div>`;
      btn.addEventListener('click', () => selectServicio(s));
      contenedor.appendChild(btn);
    });
  }

  /* Actualiza el resumen y bloquea la selección de servicio */
  function selectServicio(s) {
    servicioInput.value = s.id;
    resumenImg.src = s.imagen;
    resumenImg.alt = s.nombre;
    resumenNombre.textContent = s.nombre;
    resumenPrecio.textContent = `$${s.precio}`;
    resumenCategoria.textContent = (currentCategory || '').charAt(0).toUpperCase() + (currentCategory || '').slice(1);
    resumen.hidden = false;

    /* Muestra solo la tarjeta seleccionada */
    contenedor.innerHTML = '';
    const singleCard = createCardElement(s);
    singleCard.classList.add('single', 'selected');
    contenedor.appendChild(singleCard);

    /* Botón para cambiar servicio */
    const changeWrap = document.createElement('div');
    changeWrap.className = 'change-wrap';
    const changeBtn = document.createElement('button');
    changeBtn.type = 'button';
    changeBtn.className = 'btn-change';
    changeBtn.textContent = 'Cambiar servicio';
    changeBtn.addEventListener('click', () => {
      renderServicios(currentCategory);
      servicioInput.value = '';
      resumen.hidden = true;
    });
    changeWrap.appendChild(changeBtn);
    contenedor.appendChild(changeWrap);
  }

  /* Escucha los cambios en el selector de categoría */
  tipoSelect.addEventListener('change', function(){
    renderServicios(this.value);
    servicioInput.value='';
    resumen.hidden = true;
  });

  /* Si ya hay una categoría seleccionada (por ejemplo al volver atrás), se renderiza automáticamente */
  if (tipoSelect.value) renderServicios(tipoSelect.value);
});
</script>

{% endblock %}
