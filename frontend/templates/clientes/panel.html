<!-- filepath: c:\Users\juanv\Desktop\proyecto Gise-Nails\frontend\templates\clientes\panel.html -->
{% extends 'base_cliente.html' %}
{% load static %}
{% load token_filters %}
{% block content %}

<div class="card mb-4">
    <div class="card-header">
        <h3 class="fw-bold mb-0"><i class="bi bi-person-circle me-2"></i> Información del cliente</h3>
    </div>
    <div class="card-body">
        <p><strong>Nombre:</strong> {{ cliente.nombre }}</p>
        <p><strong>Correo:</strong> {{ cliente.correo }}</p>
        <p><strong>Teléfono:</strong> {{ cliente.telefono }}</p>
        <p><strong>Fecha de registro:</strong> {{ cliente.fecha_registro|date:"d/m/Y H:i" }}</p>
    </div>
</div>

<div class="card mb-3">
  <div class="card-header d-flex justify-content-between align-items-center flex-wrap gap-2">
    <h3>Mis citas</h3>

    <!-- FILTROS -->
    <div class="d-flex align-items-center gap-2 flex-wrap">
      <form method="get" class="d-flex align-items-center gap-2">
        <select class="form-select" name="estado">
          <option value="">Todos los estados</option>
          <option value="pendiente">Pendiente</option>
          <option value="completada">Completada</option>
          <option value="cancelada">Cancelada</option>
        </select>

        <input type="date" name="fecha" class="form-control" />

        <button type="submit" class="btn btn-primary"><i class="bi bi-funnel-fill"></i></button>

        <a href="{% url 'clientes:panel' %}" class="btn btn-secondary">
          <i class="bi bi-brush-fill"></i>
        </a>
      </form>
    </div>
  </div>

  <div class="card-body">
    {% if reservas %}
    <div class="table-responsive">
      <table class="table">
        <thead>
          <tr>
            <th>Fecha</th>
            <th>Hora</th>
            <th>Servicio</th>
            <th>Gestora</th>
            <th>Estado</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          {% for cita in reservas %}
          <tr>
            <td>{{ cita.fecha|date:"d/m/Y" }}</td>
            <td>{{ cita.hora }}</td>
            <td>{{ cita.servicio }}</td>
            <td>{{ cita.gestora }}</td>
            <td><span class="badge bg-info">{{ cita.get_estado_display }}</span></td>
            <td>
              {% if cita.estado == 'pendiente' %}
              <div class="d-flex flex-wrap gap-1">

                <!-- CONFIRMAR (POST con ID encriptado) -->
                <form method="post" action="{% url 'clientes:confirmar' cita.pk|encrypt_id %}" class="confirmar-form" style="display:inline;">
                  {% csrf_token %}
                  <button type="button" class="btn btn-success btn-sm py-0 confirmar-btn">
                    <i class="bi bi-check-circle"></i> Confirmar
                  </button>
                </form>

                <!-- CANCELAR (GET con ID encriptado) -->
                <a href="{% url 'clientes:cancelar' cita.pk|encrypt_id %}" class="btn btn-danger btn-sm py-0">
                  <i class="bi bi-x-circle"></i> Cancelar
                </a>

              </div>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- PAGINACIÓN -->
    <nav aria-label="Paginación de reservas">
      <ul class="pagination justify-content-center">

        {% if reservas.has_previous %}
        <li class="page-item">
          <a class="page-link" href="?page={{ reservas.previous_page_number }}&estado={{ filter_estado }}&fecha={{ filter_fecha }}">
            Anterior
          </a>
        </li>
        {% else %}
        <li class="page-item disabled"><span class="page-link">Anterior</span></li>
        {% endif %}

        {% for num in reservas.paginator.page_range %}
        <li class="page-item {% if reservas.number == num %}active{% endif %}">
          <a class="page-link" href="?page={{ num }}&estado={{ filter_estado }}&fecha={{ filter_fecha }}">
            {{ num }}
          </a>
        </li>
        {% endfor %}

        {% if reservas.has_next %}
        <li class="page-item">
          <a class="page-link" href="?page={{ reservas.next_page_number }}&estado={{ filter_estado }}&fecha={{ filter_fecha }}">
            Siguiente
          </a>
        </li>
        {% else %}
        <li class="page-item disabled"><span class="page-link">Siguiente</span></li>
        {% endif %}
      </ul>
    </nav>

    {% else %}
    <p class="text-muted">No tienes citas pendientes.</p>
    {% endif %}
  </div>
</div>

<!-- MODALES (SIN CAMBIOS) -->
{{ block.super }}

{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
  var panel_url = "{% url 'clientes:panel' %}";
  var show_cita_alert = {{ show_cita_alert|yesno:"true,false" }};
  var show_modal = {{ show_modal|yesno:"true,false" }};
  var update_error = "{{ update_error|default_if_none:''|escapejs }}";
  var update_success = "{{ update_success|default_if_none:''|escapejs }}";
</script>

<script src="{% static 'js/panel_cliente.js' %}"></script>
{% endblock %}
