{% extends 'home.html' %}
{% load static %}

{% block extra_head %}
  <link rel="stylesheet" href="{% static 'css/login.css' %}" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
{% endblock %}

{% block title %}
  Login / Registro
{% endblock %}

{% block content %}
  <main>
    <div class="wrapper {% if register_active %}active{% endif %}">
      <!-- FORMULARIO LOGIN / RESTABLECER / NUEVA CONTRASEÑA -->
      <div class="form-box login">
        {% if show_set_password_form %}
          <h2>Ingresa nueva contraseña</h2>
          {% if set_password_success %}
            <div class="login-alert">{{ set_password_success }}</div>
            <a href="{% url 'login:login' %}" class="btn" style="margin-top:1rem;">Iniciar sesión</a>
          {% elif set_password_error %}
            <div class="login-alert">{{ set_password_error }}</div>
            <a href="{% url 'login:password_reset' %}" class="btn" style="margin-top:1rem;">Solicitar nuevo enlace</a>
          {% else %}
            <form method="post" autocomplete="off">
              {% csrf_token %}
              <div class="input-box">
                <span class="icon"><ion-icon name="lock-closed"></ion-icon></span>
                {{ form_set_password.password }}
                <label>Nueva contraseña</label>
              </div>
              <button type="submit" class="btn">Restablecer</button>
            </form>
          {% endif %}
        {% elif show_reset_form %}
          <h2>Restablecer contraseña</h2>
          {% if reset_success %}
            <div class="login-alert">{{ reset_success }}</div>
          {% else %}
            <form method="post" autocomplete="off">
              {% csrf_token %}
              {% if reset_error %}
                <div class="login-alert">{{ reset_error }}</div>
              {% endif %}
              <div class="input-box">
                <span class="icon"><ion-icon name="mail"></ion-icon></span>
                {{ reset_form.email }}
                <label>Correo</label>
              </div>
              <button type="submit" name="reset_password" class="btn">Enviar correo</button>
            </form>
          {% endif %}
          <div class="login-register">
            <p>¿No tienes cuenta? <a href="{% url 'login:registro' %}" class="register-link">Regístrate</a></p>
            <a href="{% url 'login:login' %}">Volver al login</a>
          </div>
        {% else %}
          <h2>Iniciar sesión</h2>
          <form method="post" autocomplete="on">
            {% csrf_token %}
            {% if error %}
              <div class="login-alert">{{ error }}</div>
            {% endif %}
            <div class="input-box">
              <span class="icon"><ion-icon name="mail"></ion-icon></span>
              <input type="email" name="email" value="{{ prefill_email|default:'' }}" required />
              <label>Email</label>
            </div>
            <div class="input-box">
              <span class="icon"><ion-icon name="lock-closed"></ion-icon></span>
              <input type="password" name="password" required />
              <label>Password</label>
            </div>
            <button type="submit" class="btn">Entrar</button>
            <div class="login-register">
              <p>¿No tienes cuenta? <a href="#" class="register-link">Regístrate</a></p>
              <p><a href="{% url 'login:login' %}?show_reset=true">¿Olvidaste tu contraseña?</a></p>
            </div>
          </form>
        {% endif %}
      </div>

      <!-- FORMULARIO REGISTRO -->
      <div class="form-box register">
        <h2>Registro</h2>
        <form method="post" autocomplete="off" action="{% url 'login:registro' %}">
          {% csrf_token %}
          {% if pending_message %}
            <div class="pending-reserva-message" style="margin-bottom:1rem;">
              <p>Hemos guardado tu cita pendiente. Crea tu cuenta y después completaremos la reserva automáticamente.</p>
            </div>
          {% endif %}
          {% if register_form.errors %}
            <div class="login-alert">Por favor revisa los datos ingresados.</div>
          {% endif %}
          <div class="input-box">
            <span class="icon"><ion-icon name="person"></ion-icon></span>
            <input type="text" name="nombre" id="id_nombre" value="{{ initial.nombre|default:'' }}" required />
            <label>Nombre</label>
          </div>
          <div class="input-box">
            <span class="icon"><ion-icon name="mail"></ion-icon></span>
            <input type="email" name="correo" id="id_correo" value="{{ prefill_email|default:'' }}" required />
            <label>Email</label>
          </div>
          <div class="input-box">
            <span class="icon"><ion-icon name="call"></ion-icon></span>
            <input type="text" name="telefono" id="id_telefono" value="{{ initial.telefono|default:'' }}" required />
            <label>Teléfono</label>
          </div>
          <div class="input-box">
            <span class="icon"><ion-icon name="lock-closed"></ion-icon></span>
            <input type="password" name="password" id="id_password" required />
            <label>Password</label>
          </div>
          <button type="submit" class="btn" style="display: block; margin-top: 1rem;">Registrarme</button>
          {% if register_form.non_field_errors %}
            <div class="error">{{ register_form.non_field_errors }}</div>
          {% endif %}
          {{ register_form.nombre.errors }}
          {{ register_form.correo.errors }}
          {{ register_form.telefono.errors }}
          {{ register_form.password.errors }}
          <div class="login-register">
            <p>¿Ya tienes cuenta? <a href="#" class="login-link">Inicia sesión</a></p>
          </div>
        </form>
      </div>
    </div>
  </main>
  <style>
    footer {
      display: none !important;
    }
  </style>
{% endblock %}

{% block scripts %}
  {{ block.super }}
  <script src="{% static 'js/login.js' %}"></script>
  <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
  <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
  {% if register_active %}
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        const wrapper = document.querySelector('.wrapper');
        if (wrapper) {
          wrapper.classList.add('active');
        }
        const registerLink = document.querySelector('.register-link');
        if (registerLink) {
          registerLink.click();
        }
      });
    </script>
  {% endif %}
{% endblock %}
