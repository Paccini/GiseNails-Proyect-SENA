{% extends 'base_admin.html' %}
<!-- Extiende la plantilla base del panel de administración llamada 'base_admin.html' -->

{% block content %}
  <!-- Inicio del bloque de contenido principal -->

  <style>
    .dot {
      display: inline-block;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      border: 1px solid rgba(0, 0, 0, 0.08);
    }
    .dot-green {
      background: #28a745;
    }
    .dot-gray {
      background: #6c757d;
    }
    .btn-dot {
      padding: 2px 6px;
      border: none;
      background: transparent;
    }
  </style>

  <div class="mb-3 d-flex justify-content-between align-items-center">
    <!-- Encabezado con título y botón para agregar empleados -->
    <h2 class="fs-4 fw-semibold"><i class="bi bi-list-ul me-2"></i> Gestión de Empleados</h2>
    <a href="{% url 'empleados:empleado_create' %}" class="btn btn-primary d-flex align-items-center gap-2"><i class="bi bi-plus-lg fs-5"></i> Agregar</a>
  </div>

  <div class="card shadow mb-4">
    <div class="card-body">
      <!-- Formulario de búsqueda -->
      <form method="get" class="d-flex justify-content-end mb-3">
        <input type="text" name="q" value="{{ q }}" class="form-control w-auto" placeholder="Buscar empleado..." style="min-width:200px;" />
        <button type="submit" class="btn btn-primary ms-2"><i class="bi bi-search"></i></button>
      </form>

      <!-- Tabla de empleados -->
      <div class="table-responsive">
        <table class="table table-hover align-middle">
          <thead class="table-light">
            <tr>
              <th>
                <i class="bi bi-person me-1"></i> Nombre
              </th>
              <th>
                <i class="bi bi-person-badge me-1"></i> Apellidos
              </th>
              <th>
                <i class="bi bi-envelope me-1"></i> Correo
              </th>
              <th>
                <i class="bi bi-image me-1"></i> Foto
              </th>
              <th>
                <i class="bi bi-gear me-1"></i> Acciones
              </th>
            </tr>
          </thead>

          <tbody>
            <!-- Iteración sobre la lista de empleados -->
            {% for empleado in empleados %}
              <tr>
                <td>
                  <i class="bi bi-person-circle me-1 text-secondary"></i>
                  {{ empleado.nombre }}
                </td>
                <td>{{ empleado.apellidos }}</td>
                <td>
                  <i class="bi bi-envelope me-1 text-secondary"></i>
                  {{ empleado.correo }}
                </td>
                <td>
                  <!-- Mostrar la foto del empleado si existe -->
                  {% if empleado.foto %}
                    <img src="{{ empleado.foto.url }}" alt="Foto de {{ empleado.nombre }}" width="48" class="rounded shadow-sm" />
                  {% else %}
                    <span class="text-muted">Sin foto</span>
                  {% endif %}
                </td>
                <td>
                  <!-- Botones de acción: editar y eliminar -->
                  <a href="{% url 'empleados:empleado_update' empleado.id %}" class="btn btn-sm btn-warning me-1" title="Editar"><i class="bi bi-pencil-square"></i></a>
                  <a href="{% url 'empleados:empleado_delete' empleado.id %}" class="btn btn-sm btn-danger me-1" title="Eliminar"><i class="bi bi-trash"></i></a>

                  <!-- Toggle inline -->
                  <button class="btn-dot"
                    data-id="{{ empleado.pk }}"
                    title="{% if empleado.activo %}
                      Activo
                    {% else %}
                      Inactivo
                    {% endif %}">
                    <span class="dot {% if empleado.activo %}
                        dot-green
                      {% else %}
                        dot-gray
                      {% endif %}">

                    </span>
                  </button>
                </td>
              </tr>
            {% empty %}
              <!-- Si no hay empleados registrados -->
              <tr>
                <td colspan="5" class="text-center">No hay empleados registrados.</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- Paginación -->
      {% if is_paginated %}
        <nav>
          <ul class="pagination justify-content-center">
            <!-- Botón de página anterior -->
            {% if page_obj.has_previous %}
              <li class="page-item">
                <a class="page-link" href="?q={{ q }}&page={{ page_obj.previous_page_number }}">Anterior</a>
              </li>
            {% endif %}

            <!-- Números de página -->
            {% for num in paginator.page_range %}
              <li class="page-item {% if page_obj.number == num %}active{% endif %}">
                <a class="page-link" href="?q={{ q }}&page={{ num }}">{{ num }}</a>
              </li>
            {% endfor %}

            <!-- Botón de página siguiente -->
            {% if page_obj.has_next %}
              <li class="page-item">
                <a class="page-link" href="?q={{ q }}&page={{ page_obj.next_page_number }}">Siguiente</a>
              </li>
            {% endif %}
          </ul>
        </nav>
      {% endif %}
    </div>
  </div>

  <script>
    ;(function () {
      function getCookie(name) {
        let v = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)')
        return v ? v.pop() : ''
      }
      const csrftoken = getCookie('csrftoken')
    
      document.querySelectorAll('.btn-dot').forEach((btn) => {
        btn.addEventListener('click', function () {
          const id = this.dataset.id
          const span = this.querySelector('.dot')
          fetch("{% url 'empleados:empleado_toggle_activo' 0 %}".replace('0', id), {
            method: 'POST',
            headers: { 'X-CSRFToken': csrftoken, Accept: 'application/json' }
          })
            .then((r) => r.json())
            .then((data) => {
              if (!data.success) {
                alert(data.error || 'Error')
                return
              }
              if (data.activo) {
                span.classList.remove('dot-gray')
                span.classList.add('dot-green')
                this.title = 'Activo'
              } else {
                span.classList.remove('dot-green')
                span.classList.add('dot-gray')
                this.title = 'Inactivo'
              }
            })
            .catch((err) => {
              console.error(err)
              alert('Error en la petición.')
            })
        })
      })
    })()
  </script>
{% endblock %}
<!-- Fin del bloque de contenido principal -->
